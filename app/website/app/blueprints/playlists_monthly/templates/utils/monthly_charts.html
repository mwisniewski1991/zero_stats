<div class="chart-container-compact">
    <div id="chart-{{ playlist.id }}" class="chart-wrapper"></div>
</div>
<script>
// D3.js chart creation for monthly playlists data
document.addEventListener('DOMContentLoaded', function() {
    createMonthlyChart('{{ playlist.id }}', {{ playlist.monthly_data|tojson }}, '{{ playlist.title }}');
});

function createMonthlyChart(playlistId, monthlyData, playlistTitle) {
    const config = getMonthlyChartConfig();
    const dimensions = calculateMonthlyDimensions(playlistId, config);
    
    // Clear previous content and setup
    const tooltip = createMonthlyTooltip();
    const svg = setupMonthlyChart(playlistId, dimensions);
    
    // Create scales
    const { xScale, yScale } = createMonthlyScales(monthlyData, dimensions);
    
    // Create second Y scale for video count
    const yScaleVideos = createVideoCountScale(monthlyData, dimensions);
    
    // Draw chart elements
    drawMonthlyAxes(svg, xScale, yScale, dimensions);
    drawMonthlyBars(svg, monthlyData, xScale, yScale, dimensions, tooltip, playlistTitle);
    drawVideoCountDots(svg, monthlyData, xScale, yScaleVideos, dimensions, tooltip, playlistTitle);
    drawMonthlyAverageLine(svg, monthlyData, yScale, dimensions);
    drawMonthlyYAxisLabel(svg, dimensions, config);
}

function getMonthlyChartConfig() {
    return {
        margin: {top: 10, right: 15, bottom: 15, left: 50},
        height: 150,
        colors: {
            bars: "#f0302e",
            hover: "#fff",
            average: "#fff",
            text: "#e0e0e0"
        }
    };
}

function calculateMonthlyDimensions(playlistId, config) {
    const container = document.getElementById(`chart-${playlistId}`);
    const containerWidth = container.offsetWidth - 16;
    const width = containerWidth - config.margin.left - config.margin.right;
    const height = config.height - config.margin.top - config.margin.bottom;
    
    return { width, height, margin: config.margin };
}

function setupMonthlyChart(playlistId, dimensions) {
    d3.select(`#chart-${playlistId}`).html('');
    
    return d3.select(`#chart-${playlistId}`)
        .append("svg")
        .attr("width", dimensions.width + dimensions.margin.left + dimensions.margin.right)
        .attr("height", dimensions.height + dimensions.margin.top + dimensions.margin.bottom)
        .append("g")
        .attr("transform", `translate(${dimensions.margin.left},${dimensions.margin.top})`);
}

function createMonthlyTooltip() {
    return d3.select("body").append("div")
        .attr("class", "chart-tooltip")
        .style("opacity", 0);
}

function createMonthlyScales(monthlyData, dimensions) {
    const xScale = d3.scaleBand()
        .range([0, dimensions.width])
        .domain(monthlyData.map(d => d.year_month))
        .padding(0.2);
    
    const maxViews = d3.max(monthlyData, d => d.total_views);
    const yScale = d3.scaleLinear()
        .domain([0, maxViews])
        .range([dimensions.height, 0]);
    
    return { xScale, yScale };
}

function createVideoCountScale(monthlyData, dimensions) {
    const maxVideos = d3.max(monthlyData, d => d.video_count);
    return d3.scaleLinear()
        .domain([0, maxVideos])
        .range([dimensions.height, 0]);
}

function drawMonthlyAxes(svg, xScale, yScale, dimensions) {
    // Custom formatter for Y axis labels
    function formatYAxisLabel(d) {
        if (d >= 1000000) {
            return (d / 1000000).toFixed(0) + 'M';
        } else if (d >= 1000) {
            return (d / 1000).toFixed(0) + 'k';
        } else {
            return d.toString();
        }
    }
    
    // X axis without labels - only axis line
    svg.append("g")
        .attr("transform", `translate(0,${dimensions.height})`)
        .call(d3.axisBottom(xScale).tickSize(0).tickFormat(""));
    
    // Y axis - fewer ticks and smaller font
    svg.append("g")
        .call(d3.axisLeft(yScale).ticks(3).tickFormat(formatYAxisLabel).tickSize(3))
        .selectAll("text")
        .style("font-size", "8px")
        .style("opacity", 0.7);
}

function drawMonthlyBars(svg, monthlyData, xScale, yScale, dimensions, tooltip, playlistTitle) {
    const config = getMonthlyChartConfig();
    
    svg.selectAll("monthly-bar")
        .data(monthlyData)
        .join("rect")
        .attr("x", d => xScale(d.year_month))
        .attr("y", d => yScale(d.total_views))
        .attr("width", xScale.bandwidth())
        .attr("height", d => dimensions.height - yScale(d.total_views))
        .attr("fill", config.colors.bars)
        .attr("opacity", 0.8)
        .on("mouseover", function(event, d) {
            handleMonthlyBarHover(this, event, d, tooltip, config.colors.hover, playlistTitle);
        })
        .on("mouseout", function(event, d) {
            handleMonthlyBarMouseOut(this, tooltip, config.colors.bars);
        });
}

function drawVideoCountDots(svg, monthlyData, xScale, yScaleVideos, dimensions, tooltip, playlistTitle) {
    svg.selectAll("video-count-dot")
        .data(monthlyData)
        .join("circle")
        .attr("cx", d => xScale(d.year_month) + xScale.bandwidth() / 2)
        .attr("cy", d => yScaleVideos(d.video_count))
        .attr("r", 2)
        .attr("fill", "#fff")
        .attr("opacity", 0.75)
        .on("mouseover", function(event, d) {
            handleVideoDotHover(this, event, d, tooltip, playlistTitle);
        })
        .on("mouseout", function(event, d) {
            handleVideoDotMouseOut(this, tooltip);
        });
}

function handleMonthlyBarHover(element, event, data, tooltip, hoverColor, playlistTitle) {
    d3.select(element).attr("fill", hoverColor).attr("opacity", 0.8);
    
    tooltip.transition()
        .duration(200)
        .style("opacity", .9);
    tooltip.html(`${d3.format(",")(data.total_views)} wyświetleń<br/>${data.year_month}`)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
}

function handleVideoDotHover(element, event, data, tooltip, playlistTitle) {
    d3.select(element).attr("r", 4).attr("opacity", 1);
    
    tooltip.transition()
        .duration(200)
        .style("opacity", .9);
    tooltip.html(`Ilość filmów: ${data.video_count}<br/>${data.year_month}`)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
}

function handleVideoDotMouseOut(element, tooltip) {
    d3.select(element).attr("r", 3).attr("opacity", 0.75);
    
    tooltip.transition()
        .duration(500)
        .style("opacity", 0);
}

function handleMonthlyBarMouseOut(element, tooltip, originalColor) {
    d3.select(element).attr("fill", originalColor);
    
    tooltip.transition()
        .duration(500)
        .style("opacity", 0);
}

function drawMonthlyAverageLine(svg, monthlyData, yScale, dimensions) {
    const config = getMonthlyChartConfig();
    const averageViews = d3.mean(monthlyData, d => d.total_views);
    
    // Average line
    svg.append("line")
        .attr("x1", 0)
        .attr("x2", dimensions.width)
        .attr("y1", yScale(averageViews))
        .attr("y2", yScale(averageViews))
        .attr("stroke", config.colors.average)
        .attr("stroke-width", 1)
        .attr("stroke-dasharray", "5,5")
        .attr("opacity", 0.6);
    
    // Average line label - smaller font
    svg.append("text")
        .attr("x", dimensions.width - 2)
        .attr("y", yScale(averageViews) - 2)
        .attr("text-anchor", "end")
        .style("font-size", "8px")
        .style("fill", config.colors.average)
        .style("opacity", 0.6)
        .text(`Śr: ${formatCompactNumber(Math.round(averageViews))}`);
}

function formatCompactNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(0) + 'k';
    } else {
        return num.toString();
    }
}

function drawMonthlyYAxisLabel(svg, dimensions, config) {
    svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - dimensions.margin.left + 10)
        .attr("x", 0 - (dimensions.height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .style("font-size", "10px")
        .style("opacity", 0.6)
        .style("fill", config.colors.text)
        .text("Wyświetlenia");
}
</script>