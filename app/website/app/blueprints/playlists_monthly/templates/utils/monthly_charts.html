<div class="col-12">
    <div class="mb-2">
        <small class="text-muted">Okres: od stycznia 2024 do bieżącego miesiąca</small>
    </div>
    <div id="chart-{{ playlist.id }}" class="chart-container"></div>
</div>
<script>
// D3.js chart creation for monthly playlists data
document.addEventListener('DOMContentLoaded', function() {
    createMonthlyChart('{{ playlist.id }}', {{ playlist.monthly_data|tojson }}, '{{ playlist.title }}');
});

function createMonthlyChart(playlistId, monthlyData, playlistTitle) {
    const config = getMonthlyChartConfig();
    const dimensions = calculateMonthlyDimensions(playlistId, config);
    
    // Clear previous content and setup
    const tooltip = createMonthlyTooltip();
    const svg = setupMonthlyChart(playlistId, dimensions);
    
    // Create scales
    const { xScale, yScale } = createMonthlyScales(monthlyData, dimensions);
    
    // Draw chart elements
    drawMonthlyAxes(svg, xScale, yScale, dimensions);
    drawMonthlyBars(svg, monthlyData, xScale, yScale, dimensions, tooltip, playlistTitle);
    drawMonthlyAverageLine(svg, monthlyData, yScale, dimensions);
    drawMonthlyYAxisLabel(svg, dimensions, config);
}

function getMonthlyChartConfig() {
    return {
        margin: {top: 15, right: 30, bottom: 60, left: 90},
        height: 250,
        colors: {
            bars: "#f0302e",
            hover: "#fff",
            average: "#fff",
            text: "#e0e0e0"
        }
    };
}

function calculateMonthlyDimensions(playlistId, config) {
    const container = document.getElementById(`chart-${playlistId}`);
    const containerWidth = container.offsetWidth - 32;
    const width = containerWidth - config.margin.left - config.margin.right;
    const height = config.height - config.margin.top - config.margin.bottom;
    
    return { width, height, margin: config.margin };
}

function setupMonthlyChart(playlistId, dimensions) {
    d3.select(`#chart-${playlistId}`).html('');
    
    return d3.select(`#chart-${playlistId}`)
        .append("svg")
        .attr("width", dimensions.width + dimensions.margin.left + dimensions.margin.right)
        .attr("height", dimensions.height + dimensions.margin.top + dimensions.margin.bottom)
        .append("g")
        .attr("transform", `translate(${dimensions.margin.left},${dimensions.margin.top})`);
}

function createMonthlyTooltip() {
    return d3.select("body").append("div")
        .attr("class", "chart-tooltip")
        .style("opacity", 0);
}

function createMonthlyScales(monthlyData, dimensions) {
    const xScale = d3.scaleBand()
        .range([0, dimensions.width])
        .domain(monthlyData.map(d => d.year_month))
        .padding(0.2);
    
    const maxViews = d3.max(monthlyData, d => d.total_views);
    const yScale = d3.scaleLinear()
        .domain([0, maxViews])
        .range([dimensions.height, 0]);
    
    return { xScale, yScale };
}

function drawMonthlyAxes(svg, xScale, yScale, dimensions) {
    // Custom formatter for Y axis labels
    function formatYAxisLabel(d) {
        if (d >= 1000000) {
            return (d / 1000000).toFixed(1) + 'M';
        } else if (d >= 1000) {
            return d3.format(",")(d).replace(/,/g, ' ');
        } else {
            return d.toString();
        }
    }
    
    // X axis with month labels
    svg.append("g")
        .attr("transform", `translate(0,${dimensions.height})`)
        .call(d3.axisBottom(xScale))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-45)")
        .style("opacity", 0.75);
    
    // Y axis
    svg.append("g")
        .call(d3.axisLeft(yScale).ticks(5).tickFormat(formatYAxisLabel))
        .style("opacity", 0.75);
}

function drawMonthlyBars(svg, monthlyData, xScale, yScale, dimensions, tooltip, playlistTitle) {
    const config = getMonthlyChartConfig();
    
    svg.selectAll("monthly-bar")
        .data(monthlyData)
        .join("rect")
        .attr("x", d => xScale(d.year_month))
        .attr("y", d => yScale(d.total_views))
        .attr("width", xScale.bandwidth())
        .attr("height", d => dimensions.height - yScale(d.total_views))
        .attr("fill", config.colors.bars)
        .attr("opacity", 0.8)
        .on("mouseover", function(event, d) {
            handleMonthlyBarHover(this, event, d, tooltip, config.colors.hover, playlistTitle);
        })
        .on("mouseout", function(event, d) {
            handleMonthlyBarMouseOut(this, tooltip, config.colors.bars);
        });
}

function handleMonthlyBarHover(element, event, data, tooltip, hoverColor, playlistTitle) {
    d3.select(element).attr("fill", hoverColor).attr("opacity", 0.8);
    
    tooltip.transition()
        .duration(200)
        .style("opacity", .9);
    tooltip.html(`<strong>${playlistTitle}</strong><br/>${d3.format(",")(data.total_views)} wyświetleń<br/>${data.video_count} filmów`)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
}

function handleMonthlyBarMouseOut(element, tooltip, originalColor) {
    d3.select(element).attr("fill", originalColor);
    
    tooltip.transition()
        .duration(500)
        .style("opacity", 0);
}

function drawMonthlyAverageLine(svg, monthlyData, yScale, dimensions) {
    const config = getMonthlyChartConfig();
    const averageViews = d3.mean(monthlyData, d => d.total_views);
    
    // Average line
    svg.append("line")
        .attr("x1", 0)
        .attr("x2", dimensions.width)
        .attr("y1", yScale(averageViews))
        .attr("y2", yScale(averageViews))
        .attr("stroke", config.colors.average)
        .attr("stroke-width", 1)
        .attr("stroke-dasharray", "10,10")
        .attr("opacity", 0.8);
    
    // Average line label
    svg.append("text")
        .attr("x", dimensions.width - 5)
        .attr("y", yScale(averageViews) - 5)
        .attr("text-anchor", "end")
        .style("font-size", "12px")
        .style("fill", config.colors.average)
        .style("opacity", 0.75)
        .text(`Średnia: ${d3.format(",")(Math.round(averageViews))}`);
}

function drawMonthlyYAxisLabel(svg, dimensions, config) {
    svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - dimensions.margin.left + 5)
        .attr("x", 0 - (dimensions.height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .style("font-size", "14px")
        .style("opacity", 0.75)
        .style("fill", config.colors.text)
        .text("Suma wyświetleń");
}
</script>